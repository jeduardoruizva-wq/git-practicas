name: Stats
on: 
  push:
    branches: [main]

jobs: 
  build: 
    runs-on: ubuntu-latest
    steps: 
       - name: checkout repo
         uses: actions/checkout@v4
       - name: Set up Google Cloud
         uses: google-github-actions/setup-gcloud@v2
         with:
            project_id: ${{ secrets.GCP_PROJECT }}
            service_account_key: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
       - name: Install Apigee CLI
         run: |
          curl -L https://github.com/apigee/apigeecli/releases/latest/download/apigeecli_Linux_x86_64.tar.gz -o apigeecli.tar.gz tar -xzf apigeecli.tar.gz chmod +x apigeecli sudo mv apigeecli /usr/local/bin/

       - name: Create proxy bundle
         env:
          APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
         run: |
          apigeecli apis create bundle \
            --name ${{ secrets.PROXY_NAME }} \
            --bundle ./apiproxy \
            --org $APIGEE_ORG || echo "Bundle may already exist"
       - name: Get latest revision
         id: revision
         env:
          APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
         run: |
          REV=$(apigeecli apis list --org $APIGEE_ORG --name ${{ secrets.PROXY_NAME }} --json | jq -r '.[0].revision')
          echo "revision=$REV" >> $GITHUB_OUTPUT
       - name: Deploy to Apigee environment
         env:
          APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
          APIGEE_ENV: ${{ secrets.APIGEE_ENV }}
         run: |
          apigeecli apis deploy \
            --name ${{ secrets.PROXY_NAME }} \
            --rev ${{ steps.revision.outputs.revision }} \
            --env $APIGEE_ENV \
            --org $APIGEE_ORG
